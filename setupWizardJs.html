<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
  //global variables
  var orgTeams = [];
  
  //initialization
  $(function(){
    //button handlers
    $('#s1-next').click(s1Forward);
    $('#s2-back').click(s2Back);
    $('#s2-next').click(s2Forward);
    $('#s3-back').click(s3Back);
    $('#s3-next').click(s3Next);
    $('#s4-back').click(s4Back);
    $('#s4-next').click(s4Next);
    $('#s5-back').click(s5Back);
    $('#s5-next').click(s5Next);
    $('#tournament-sku').change(textSkuEntered);
    $('#show-sku-input').click(showSkuInput);
    $('#s5-next-confirm').click(s5NextConfirmed);
    $('#error-restart').click(restartWizard);
  });
    
  function showSkuInput() {
    $('#sku-input-div').removeClass('hidden');
    $('#show-sku-input').addClass('hidden');
  }
   
  function changeView(prevStep, nextStep, triggerFunction) {
    var startStepId = '#step' + prevStep,
        newStepId = '#step' + nextStep;
    
    $(startStepId).addClass('hidden');
    if(triggerFunction) {
      $(newStepId).trigger(triggerFunction).removeClass('hidden');
    } else {
      $(newStepId).removeClass('hidden');
    }
  }
  
  
  function s2Load() {
    //do something
  }
  
  //navigation functions
  function s1Forward() {
    //show next step
    changeView(1,2);
    
    getCurrentEventsList(); //get the list of current events
  }
  
  function s2Back() {
    changeView(2,1);
  }
  
  function textSkuEntered() {
    console.log("Function fired");
    $('#warn-text-sku-entry').removeClass('hidden');
    $('input[name="event-select"]').prop("checked",false); //deselect any radio button selected
  }
  
  function s2Forward() {
    var eventRadioBtnSelected = true,
        noSkuGiven = false;
        console.log("s2Forward ran");
    if ($('#tournament-sku').val()) { //if the user entered a value for the tournament sku in the text box, use that
      sku = $('#tournament-sku').val().trim().toUpperCase(); //get the SKU the user entered, then remove leading and trailing spaces and make sure it's in uppercase
      noSkuGiven = false; //make sure this is false in this case because this function can be run multiple times in a session
    } else if ($('input[name="event-select"]').is(":checked")) { //event selected
      sku = $('input[name="event-select"]:checked').val();
      noSkuGiven = false; //make sure this is false in this case because this function can be run multiple times in a session
    } else {
      $('#no-event-selected').removeClass('hidden'); //show an error message - the user didn't enter an sku and didn't select an event radio button
      noSkuGiven = true;
    }
  
    if (!noSkuGiven) {
      console.log(sku);
      changeView(2,3); //only continue if an SKU was provided by the user
    }
  }
  
  function s3Back() {
    changeView(3,2);
  }
  
  function s3Next() {
    processOrgTeams();
    changeView(3,4);
  }
  
  function s4Back() {
    changeView(4,3);
  }
  
  function s4Next() {
    changeView(4,5);
  }
  
  function s5Back() {
    changeView(5,4);
  }
  
  function s5Next() {
    //before continuing, confirm that this is what the user wanted to do to prevent accidental submissions.  after this, WARS will process the data given in the wizard
    /*$('#confirm-s5-continue').removeClass('hidden');
    $('#s5-back').append(' a step');
    $('#s5-next').addClass('hidden');
    $('#s5-confirm-back').removeClass('hidden');
    $('#s5-confirm-next').removeClass('hidden');*/
    changeView(5,6);
    processTeamData();
  }
  
  function s5NextConfirmed() { //after user has confirmed that they are ready for WARS to proess this data, this function will run
    changeView(5,6);
    processTeamData();
  }
  
  function s6Success() {
    changeView(6,7);
  }
  
  function s6Error() {
    changeView(6,8);
  }
  
  function restartWizard() {
    //empty input fields that are not dynamically generated (the number of people on each team boxes are dynamically generated and do not need to be emptied)
    $('#tournament-sku').val('');
    $('#org-teams').val('');
    
    //return to the first step
    changeView(8,1);
  }
  
  var sku = "";
  
  function showStatus(msg, classId) {
    $('#status').removeClass().html(msg);
    if (classId) {
      $('#status').addClass(classId);
    }
  }
  var teams;
  function processOrgTeams() {
     teams = $('#org-teams').val().toUpperCase().split(/\n/g); //create an array for each row of data in the textarea
      var  currentTeam;
    $('#team-list').empty(); //make sure that no teams are shown twice if the user goes back
    for (var i = 0; i < teams.length; i++) { //list the teams the user entered in the previous step
      currentTeam = teams[i];
      if (!currentTeam) { //don't show input boxes for blank lines
        continue;
      }
      orgTeams.push(teams[i])
      console.log(teams[i]);
      $('#team-list').append('<p><strong><label for="' + currentTeam + '">' + currentTeam + '</label></strong> <input type="text" id="' + currentTeam + '" /></p>');
    }
    orgTeams.push("addl-members");
    $('#team-list').append('<p><strong><label for="addl-members">Additional team members</label></strong> <input type="text" id="addl-members" /></p>'); //show an input for additional team members
    
  }
  
  function checkFormCreationStatus(status) {
    if (status.scoutingForm && status.interviewForm) { //if both forms were successfully created, then proceed to the next step (running the match importance rating algorithm
      $('#create-forms-status').append('done!');
      sendMIRInfo();
    } else if(status.scoutingForm === "error" || status.interviewForm === "error") { //if there was a problem creatiang either of the forms, go to the error page 
      s6Error();
    } //otherwise, do nothing because one of the functions isn't done running yet (i.e., wait until both forms have been created or one has given an error)
  }
  
  function refreshData() {
    google.script.run
      .withSuccessHandler(
        function(returnVal, element) {
          $('#refresh-data-status').append("done!");
          $('#create-forms-status').removeClass('hidden');
          createScoutingForm();

      })
      .withFailureHandler(
        function(error, element) {
          //order matters here.  Make sure that the error message has already been added to the page before the execution statuses are checked to ensure that if there is an error, the error message
          // is there before the error page is shown
          $('#error-list').append("Unable to get team or match data.  Make sure the SKU you entered is correct, the tournament is uploading data in real-time, and the real-time data is viewable on RobotEvents right now (if not, wait a few minutes and try again)");
          s6Error();
        })
      .refreshAllData();
  }
  
  var divisions;
  
  function getDivisions() {
      google.script.run
      .withSuccessHandler(
        function(returnVal, element) {
          $('#get-team-divisions-status').append("done!");
          $('#refresh-data-status').removeClass('hidden');
          refreshData();
          console.log("returnVal " + divisions);
          divisions = returnVal;
        
      })
      .withFailureHandler(
        function(error, element) {
          //order matters here.  Make sure that the error message has already been added to the page before the execution statuses are checked to ensure that if there is an error, the error message
          // is there before the error page is shown
          $('#error-list').append("Unable to get team division information.  Make sure the SKU you entered is correct, the tournament is uploading data in real-time, and the real-time data is viewable on RobotEvents right now (if not, wait a few minutes and try again)");
          s6Error();
        })
      .getTeamDivisions(sku, orgTeams);
  }
  
  function createInterviewForm() {
     google.script.run
      .withSuccessHandler(
        function(returnVal, element) {
          $('#create-forms-status').append("done!");
          $('get-ss-id').removeClass('hidden');
          getWARSWebUrl();

      })
      .withFailureHandler(
        function(error, element) {
          //order matters here.  Make sure that the error message has already been added to the page before the execution statuses are checked to ensure that if there is an error, the error message
          // is there before the error page is shown
          $('#error-list').append("Unable to create team interview form.  Make sure you're signed in to an @woodward.edu Google account");
          status.interviewForm = "error";
          s6Error();
        })
      .createInterviewForm();
   }
   
   function getWARSWebUrl() {
     google.script.run
      .withSuccessHandler(
        function(ssId, element) {
          $('#wars-web-url').append('<a href="https://script.google.com/macros/s/AKfycbyTkgLPRNpwivT4qBYKACo7Z33WVStperAZ6YpdwHXERVjuiWc/exec?id=' + ssId + '">https://script.google.com/macros/s/AKfycbyTkgLPRNpwivT4qBYKACo7Z33WVStperAZ6YpdwHXERVjuiWc/exec?sid=' + ssId + '</a>');
          $('#get-ss-id').append("done!");
          s6Success();

      })
      .withFailureHandler(
        function(error, element) {
          //order matters here.  Make sure that the error message has already been added to the page before the execution statuses are checked to ensure that if there is an error, the error message
          // is there before the error page is shown
          $('#error-list').append("Unable to get WARS Web URL.  Check your internet connection.");
          s6Error();
        })
      .getSpreadsheetID();
       
       

   }
  
  function createScoutingForm() {
    google.script.run
      .withSuccessHandler(
        function(returnVal, element) {
          createInterviewForm();
          //s6Success();
        })
      .withFailureHandler(
        function(error, element) {
          //order matters here.  Make sure that the error message has already been added to the page before the execution statuses are checked to ensure that if there is an error, the error message
          // is there before the error page is shown
          $('#error-list').append("Unable to create scouting form.  Make sure you're signed in to an @woodward.edu Google account");
          status.scoutingForm = "error";
          s6Error();
        })
        .createScoutingForm();
    
   }
  function sendMIRInfo() {
    var HITeams = $('#teams-to-scout').val().toUpperCase().split(/\n/g),
        teamData = [],
        selector,
        childNum,
        numTeamMembers;
    for (var i = 0; i < orgTeams.length; i++) { //for each team in this organization and the 'Additional team members' field
      selector = 'input[id="' + orgTeams[i] + '"]';
      console.log(selector);
      numTeamMembers = $(selector).val();
      for (var j = 0; j < numTeamMembers; j++) {
        teamData.push([j + 1,"", "'" + $(selector).attr("id").toUpperCase()]);
      }
    }
    //console.log(divisions);
   //for (var i = 0; i < divisions.length; i++) {
     google.script.run
           .withSuccessHandler(function() {
               s6Success();
            })
            .withFailureHandler(function() {
               $('#error-list').append("Unable to evaluate match information.  Is match information available for this tournament?");
                s6Error();
            })
            .saveScoutData(teamData, HITeams);
     //}
  }
  
  function getCurrentEventsList() {
    google.script.run
          .withSuccessHandler(
            function(returnVal, element) {
              console.log(returnVal);
              $('#events-loading').addClass('hidden');
              if (returnVal.length === 0) { //no events happening today
                $('#no-events-found').removeClass('hidden');
                showSkuInput(); //show text box to manually enter event SKU
              } else { //otherwise, process list of events and display them
                for (var i = 0; i < returnVal.length; i++) {
                  $('#events-list').append('<input type="radio" name="event-select" id="' + returnVal[i].sku + '" value="' + returnVal[i].sku + '" /><label for="' + returnVal[i].sku + '">' + returnVal[i].name + '</label> <br />');
                }
                $('#events-list').removeClass('hidden');
              }
              
            })
          .withFailureHandler(
            function(error, element) {
             
            })
          .getCurrentEvents();
  }
  
  function processTeamData() {
    var result = { sku: false, mir: false, forms: false };
    
    //s2Forward function determines which SKU to use
    
    google.script.run
          .withSuccessHandler(
            function(returnVal, element) {
              $('#save-sku-status').append("done!");
              $('#get-team-divisions-status').removeClass('hidden');
              getDivisions();
              
            })
          .withFailureHandler(
            function(error, element) {
              $('#error-list').append('Unable to save RobotEvents SKU.  Check your internet connection and try again');
              s6Error();
            })
          .savePrefs("roboteventssku",sku);
  }
</script>


